<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://img.freepik.com/free-psd/money-illustration-isolated_23-2151568514.jpg">
    <title>FinTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styles for better visual separation */
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Noto Sans Thai ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Chart.js */
            background-color: #f3f4f6; /* Gray 100 */
        }
        .container-box {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .income-color {
            color: #10b981; /* Emerald 500 */
        }
        .expense-color {
            color: #ef4444; /* Red 500 */
        }
        .balance-color {
            color: #3b82f6; /* Blue 500 */
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280; /* Gray 500 */
            transition: all 0.2s;
        }
        .tab-button:hover {
            color: #4b5563; /* Gray 600 */
        }
        .tab-button.active {
            border-color: #3b82f6; /* Blue 500 */
            color: #1f2937; /* Gray 800 */
        }
        
        /* Custom styles for Chat */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb; /* Gray 200 */
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb; /* Gray 50 */
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-between">
                
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.485 0-4.5 2.015-4.5 4.5S9.515 17 12 17s4.5-2.015 4.5-4.5S14.485 8 12 8zM12 8V5m0 3a4.5 4.5 0 014.5 4.5m-4.5-4.5a4.5 4.5 0 00-4.5 4.5m4.5-4.5v9m-4.5-9L5 7m14 10l-4.5-4.5m0 0L12 17m4.5-4.5L19 17"></path>
                    </svg>
                    <span class="text-3xl font-extrabold text-gray-900 tracking-tight">
                        <span class="text-blue-600">Fin</span>Track
                    </span>
                </div>
                <div class="ml-4">
                    <p id="authStatus" class="mt-1 text-sm text-gray-500 text-right">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="font-medium text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white px-4 sm:px-6 lg:px-8 pt-4 container-box shadow-none mb-4">
                <div class="flex border-b border-gray-200">
                    <button id="tabDashboardBtn" onclick="switchTab('dashboard')" class="tab-button active">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ</button>
                    <button id="tabTransactionBtn" onclick="switchTab('transactions')" class="tab-button">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</button>
                    <button id="tabConsultationBtn" onclick="switchTab('consultation')" class="tab-button">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ FinTrack AI</button>
                </div>
            </div>

            <div id="dashboardView">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="container-box p-6 flex flex-col items-center text-center border-l-4 border-emerald-500">
                            <p class="text-sm font-medium text-gray-500">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalIncome" class="text-2xl font-bold mt-1 income-color">0.00 ‡∏ø</p>
                        </div>
                        <div class="container-box p-6 flex flex-col items-center text-center border-l-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalExpense" class="text-2xl font-bold mt-1 expense-color">0.00 ‡∏ø</p>
                        </div>
                        <div class="container-box p-6 flex flex-col items-center text-center border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                            <p id="netBalance" class="text-2xl font-bold mt-1 balance-color">0.00 ‡∏ø</p>
                        </div>
                    </div>
                    
                    <div class="container-box p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2h-4v2h4l2-2v13c0 .552.448 1 1 1h4c.552 0 1-.448 1-1V9l2-2h4v2h-4l-2 2v10c0 .552.448 1 1 1h4c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1h-4c-.552 0-1 .448-1 1v2c0 .552-.448 1-1 1h-4c-.552 0-1 .448-1-1V5c0-.552-.448-1-1-1h-4c-.552 0-1 .448-1 1v14"></path></svg>
                            FinTrack AI: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
                        </h2>
                        <div id="categoryAnalysis" class="space-y-4">
                            <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="container-box p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                            <div class="relative h-80 flex items-center justify-center">
                                <canvas id="expensePieChart"></canvas>
                                <div id="noPieData" class="absolute inset-0 flex items-center justify-center bg-white/80 hidden">
                                    <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏î‡πâ</p>
                                </div>
                            </div>
                        </div>

                        <div class="container-box p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2>
                            <div class="relative h-80 flex items-center justify-center">
                                <canvas id="expenseBarChart"></canvas>
                                <div id="noBarData" class="absolute inset-0 flex items-center justify-center bg-white/80 hidden">
                                    <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏î‡πâ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="transactionsView" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 container-box p-6 h-fit">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
                        
                        <form onsubmit="addTransaction(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                    <div class="mt-1 flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="type" value="income" class="form-radio text-emerald-600" checked>
                                            <span class="ml-2 income-color font-medium">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="type" value="expense" class="form-radio text-red-600">
                                            <span class="ml-2 expense-color font-medium">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label for="date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                                    <input type="datetime-local" id="date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>

                                <div>
                                    <label for="amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label>
                                    <input type="number" id="amount" name="amount" required min="0.01" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1,500.00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>

                                <div>
                                    <label for="category" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select id="category" name="category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                                        <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">
                                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                            <option value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
                                            <option value="‡πÇ‡∏ö‡∏ô‡∏±‡∏™">‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
                                            <option value="‡∏•‡∏á‡∏ó‡∏∏‡∏ô">‡∏•‡∏á‡∏ó‡∏∏‡∏ô</option>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏±‡∏ö)">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏±‡∏ö)</option>
                                        </optgroup>
                                        <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢">
                                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                            <option value="‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                            <option value="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
                                            <option value="‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                                            <option value="‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á/‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á/‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</option>
                                            <option value="‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á/‡∏™‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á/‡∏™‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</option>
                                            <option value="‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                                            <option value="‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°</option>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏à‡πà‡∏≤‡∏¢)">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏à‡πà‡∏≤‡∏¢)</option>
                                        </optgroup>
                                    </select>
                                </div>

                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                    <input type="text" id="description" name="description" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü, ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>

                                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 font-semibold">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-2 container-box p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-xl font-semibold text-gray-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                            <div class="flex space-x-4">
                                <button onclick="clearAllData()" class="text-sm text-red-600 hover:text-red-800 transition duration-150 flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    <span>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                </button>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="importCSV(event)">
                                <button onclick="document.getElementById('csvFileInput').click()" class="text-sm text-gray-600 hover:text-blue-600 transition duration-150 flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</span>
                                </button>
                                <button onclick="exportCSV()" class="text-sm text-gray-600 hover:text-blue-600 transition duration-150 flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</span>
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Delete</span></th>
                                    </tr>
                                </thead>
                                <tbody id="transactionList" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="consultationView" class="hidden">
                <div class="container-box p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586M17 8V6a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2v4l.414-.414"></path></svg>
                        ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ö FinTrack AI
                    </h2>

                    <div id="chatMessages" class="chat-container">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 text-gray-800 max-w-xs lg:max-w-md p-3 rounded-t-xl rounded-br-xl shadow-md whitespace-pre-wrap">
                                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ **FinTrack AI** ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
                                
                                ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡∏∞?
                                
                                ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: **‡∏≠‡∏≠‡∏°, ‡∏•‡∏á‡∏ó‡∏∏‡∏ô, ‡∏´‡∏ô‡∏µ‡πâ, ‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢**
                            </div>
                        </div>
                        </div>

                    <form onsubmit="handleAiConsultation(event)" class="mt-4 flex space-x-3">
                        <input type="text" id="consultationInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà)" required class="flex-grow border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 font-semibold flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="messageBox" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 id="messageTitle" class="text-lg font-semibold text-gray-900 mb-3">Title</h3>
                <p id="messageBody" class="text-sm text-gray-600 mb-4">Body</p>
                <div class="flex justify-end space-x-3">
                    <button id="messageCancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition duration-150 hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="messageConfirm" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-150">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================================================================
        // LOCAL STORAGE & UTILITY SETUP - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        // =======================================================================

        const STORAGE_KEY = 'personalFinanceTransactions';
        let transactions = [];
        let userId = 'local-user'; 
        
        let pieChartInstance = null;
        let barChartInstance = null;
        const CHART_COLORS = [
            '#ef4444', 
            '#f97316', 
            '#f59e0b', 
            '#10b981', 
            '#3b82f6', 
            '#8b5cf6', 
            '#ec4899', 
            '#6b7280', 
            '#14b8a6', 
            '#a855f7', 
        ];

        /**
         * Converts number to formatted currency string (e.g., 10000 -> 10,000.00).
         * @param {number} num
         * @returns {string}
         */
        const formatCurrency = (num) => {
            return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        /**
         * Formats YYYY-MM-DDTHH:mm string to DD/MM/YYYY HH:mm ‡∏ô. (‡∏û.‡∏®.)
         */
        const formatDateTime = (isoString) => {
            if (!isoString || isoString.length < 10) return isoString;
            try {
                // Split for YYYY-MM-DD and HH:mm
                const parts = isoString.split('T'); 
                const dateParts = parts[0].split('-'); 
                
                // Fallback for date-only format (old data)
                if (dateParts.length < 3) return isoString; 

                const buddhistYear = parseInt(dateParts[0]) + 543; 
                const date = `${dateParts[2]}/${dateParts[1]}/${buddhistYear}`;
                const time = parts[1] ? parts[1] : '00:00';
                return `${date} ${time} ‡∏ô.`;
            } catch (e) {
                return isoString;
            }
        };

        /**
         * Initializes the application by loading data from Local Storage.
         */
        function initLocalStorage() {
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Auth (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
            const authStatusEl = document.getElementById('authStatus');
            authStatusEl.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="font-medium text-blue-600">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (Local Storage)</span> | ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span class="font-mono text-xs">${userId}</span>`;
            
            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            loadTransactions();
            
            // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° 
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const datetimeLocalString = now.toISOString().slice(0, 16);
            document.getElementById('date').value = datetimeLocalString;

             // 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Chart.js font
            Chart.defaults.font.family = 'Noto Sans Thai, Inter, sans-serif';
        }

        /**
         * Saves the current transactions array to Local Storage.
         */
        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                console.log("Transactions saved to Local Storage:", transactions.length);
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
                alertCustom('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        /**
         * Loads transactions from Local Storage.
         */
        function loadTransactions() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    transactions = JSON.parse(storedData).map(t => ({
                        ...t,
                        amount: parseFloat(t.amount) // Ensure amount is a number
                    }));
                } else {
                    transactions = [];
                }
                // Sort by timestamp (newest first)
                transactions.sort((a, b) => {
                    const timeA = a.timestamp || a.date;
                    const timeB = b.timestamp || b.date;
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
                    return timeB.localeCompare(timeA); 
                });

                renderTransactions();
                renderDashboard();
                console.log("Transactions loaded:", transactions.length);

            } catch (e) {
                console.error("Error loading from Local Storage:", e);
            }
        }


        // =======================================================================
        // DATA MANAGEMENT (CRUD) 
        // =======================================================================

        /**
         * Adds a new transaction.
         * @param {Event} event
         */
        window.addTransaction = function(event) {
            event.preventDefault();

            const form = event.target;
            const type = form.type.value;
            const date = form.date.value; 
            const amount = parseFloat(form.amount.value);
            const category = form.category.value;
            // ‡πÉ‡∏ä‡πâ Description ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
            const description = form.description.value.trim() || (type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'); 

            if (isNaN(amount) || amount <= 0 || !category) {
                alertCustom('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const newTransaction = {
                id: Date.now().toString() + Math.random().toString(36).substring(2, 9), 
                type,
                date, // YYYY-MM-DDTHH:mm
                amount,
                category,
                description,
                timestamp: new Date().toISOString(), 
            };

            transactions.unshift(newTransaction); 
            saveTransactions();
            loadTransactions(); 

            form.reset();
            // Reset date to current datetime
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('date').value = now.toISOString().slice(0, 16);
            
            form.category.selectedIndex = 0;
            
            switchTab('transactions'); 
        }

        /**
         * Deletes a transaction.
         * @param {string} id
         */
        window.deleteTransaction = function(id) {
            confirmCustom('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£?', () => {
                const initialLength = transactions.length;
                transactions = transactions.filter(t => t.id !== id);
                
                if (transactions.length < initialLength) {
                    saveTransactions();
                    loadTransactions(); 
                    console.log("Transaction successfully deleted locally.");
                } else {
                    alertCustom('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                }
            });
        }
        
        /**
         * Clears all data from Local Storage after confirmation.
         */
        window.clearAllData = function() {
             confirmCustom('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 
                           '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞ **‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î** ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£! ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 
                           () => {
                localStorage.removeItem(STORAGE_KEY);
                transactions = []; 
                loadTransactions(); 
                alertCustom('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
            });
        }


        // =======================================================================
        // RENDERING & UI LOGIC
        // =======================================================================

        /**
         * Renders the transaction list table.
         */
        function renderTransactions() {
            const listEl = document.getElementById('transactionList');
            if (!listEl) return;

            if (transactions.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>';
                return;
            }

            listEl.innerHTML = transactions.map(t => {
                const amountClass = t.type === 'income' ? 'income-color font-semibold' : 'expense-color font-semibold';
                const sign = t.type === 'income' ? '+' : '-';

                return `
                    <tr class="hover:bg-gray-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTime(t.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-gray-500">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${amountClass}">
                            ${sign} ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renders the expense category charts using Chart.js.
         */
        function renderCharts(categoryTotals, totalExpense) {
            // 1. Prepare data
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, amount]) => amount);
            const colors = labels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const hasData = sortedCategories.length > 0;
            document.getElementById('noPieData').classList.toggle('hidden', hasData);
            document.getElementById('noBarData').classList.toggle('hidden', hasData);

            // 2. Destroy existing chart instances if they exist
            if (pieChartInstance) {
                pieChartInstance.destroy();
                pieChartInstance = null;
            }
            if (barChartInstance) {
                barChartInstance.destroy();
                barChartInstance = null;
            }

            if (!hasData) return;

            // --- Pie Chart (All Expenses) ---
            const pieCtx = document.getElementById('expensePieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Noto Sans Thai',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(1) : 0;
                                    return `${label}: ${formatCurrency(value)} ‡∏ø (${percentage}%)`;
                                }
                            },
                            bodyFont: { family: 'Noto Sans Thai' },
                        }
                    }
                }
            });

            // --- Bar Chart (Top 5 Expenses) ---
            const top5Categories = sortedCategories.slice(0, 5);
            const barLabels = top5Categories.map(([category]) => category);
            const barData = top5Categories.map(([, amount]) => amount);
            const barColors = barLabels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const barCtx = document.getElementById('expenseBarChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)',
                        data: barData,
                        backgroundColor: barColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)',
                                font: { family: 'Noto Sans Thai' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                font: { family: 'Noto Sans Thai' }
                            }
                        },
                        y: {
                            ticks: {
                                font: { family: 'Noto Sans Thai' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { bodyFont: { family: 'Noto Sans Thai' } }
                    }
                }
            });
        }
        
        // =======================================================================
        // AI ANALYSIS FUNCTION (DEEP DIVE LOGIC)
        // =======================================================================
        
        /**
         * Generates a deep-dive AI analysis of financial data.
         * @param {number} totalIncome
         * @param {number} totalExpense
         * @param {number} netBalance
         * @param {Object} categoryTotals - { category: amount, ... }
         * @returns {string} HTML string of analysis insights.
         */
        function generateAiAnalysis(totalIncome, totalExpense, netBalance, categoryTotals) {
            if (totalIncome === 0 && totalExpense === 0) {
                return `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-gray-700 text-sm">
                            <span class="font-bold text-blue-600">FinTrack AI:</span> ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞
                        </p>
                    </div>
                `;
            }

            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            const hasNegativeBalance = netBalance < 0;
            
            let analysisHtml = '';
            
            // --- 1. Overall Financial Health ---
            const balanceIcon = hasNegativeBalance ? '‚ö†Ô∏è' : '‚úÖ';
            
            let healthMessage;
            if (hasNegativeBalance) {
                healthMessage = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô **‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á** (${formatCurrency(netBalance)} ‡∏ø ‡∏ï‡∏¥‡∏î‡∏•‡∏ö) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô`;
            } else if (totalIncome > 0 && netBalance / totalIncome > 0.3) {
                healthMessage = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô **‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°** (${formatCurrency(netBalance)} ‡∏ø ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 30% ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏°‡∏≤‡∏Å`;
            } else if (totalIncome > 0 && netBalance / totalIncome > 0.1) {
                healthMessage = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô **‡∏î‡∏µ** (${formatCurrency(netBalance)} ‡∏ø ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏≠‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô`;
            } else {
                healthMessage = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô **‡∏û‡∏≠‡πÉ‡∏ä‡πâ** (${formatCurrency(netBalance)} ‡∏ø ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á`;
            }

            analysisHtml += `
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-600">
                    <p class="text-sm font-semibold text-blue-800 flex items-center mb-1">${balanceIcon} ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:</p>
                    <p class="text-gray-700 text-sm">${healthMessage} (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: ${formatCurrency(totalIncome)} ‡∏ø / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(totalExpense)} ‡∏ø)</p>
                </div>
            `;

            // --- 2. Budget Killer Focus (Top Expense Category) ---
            if (sortedCategories.length > 0 && totalExpense > 0) {
                const topCategory = sortedCategories[0];
                const topCategoryName = topCategory[0];
                const topCategoryAmount = topCategory[1];
                const topCategoryPercentage = (topCategoryAmount / totalExpense * 100).toFixed(1);

                let killerAdvice;
                if (topCategoryPercentage >= 50) {
                    killerAdvice = `üö© **(‡∏ß‡∏¥‡∏Å‡∏§‡∏ï)** ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà **${topCategoryName}** ‡∏°‡∏µ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ñ‡∏∂‡∏á ${topCategoryPercentage}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! FinTrack AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ`;
                } else if (topCategoryPercentage >= 30) {
                    killerAdvice = `üõë **(‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á)** ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà **${topCategoryName}** (${topCategoryPercentage}%) ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10-15%`;
                } else {
                    killerAdvice = `üí° **(‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)** ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà **${topCategoryName}** (${topCategoryPercentage}%) ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å`;
                }
                
                analysisHtml += `
                    <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-600">
                        <p class="text-sm font-semibold text-yellow-800 mb-1">üî• ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Budget Killer):</p>
                        <p class="text-gray-700 text-sm">${killerAdvice}</p>
                    </div>
                `;
            }
            
            // --- 3. Proactive, Actionable Advice (Savings/Investment Rate) ---
            const savingsRate = totalIncome > 0 ? ((netBalance / totalIncome) * 100).toFixed(1) : 0;
            
            let adviceMessage = '';
            if (netBalance > 0 && totalIncome > 0) {
                if (savingsRate >= 20) {
                     adviceMessage = `üìà **‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô:** ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${savingsRate}% ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ **‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${formatCurrency(netBalance)} ‡∏ø ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á`;
                } else if (savingsRate > 0) {
                     adviceMessage = `üíµ **‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°:** ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏≠ ${savingsRate}% ‡∏ã‡∏∂‡πà‡∏á‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ FinTrack AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà **20%** ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÇ‡∏î‡∏¢‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏•‡∏á`;
                }
            } else if (hasNegativeBalance) {
                adviceMessage = `üìâ **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ:** ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ï‡∏¥‡∏î‡∏•‡∏ö FinTrack AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ú‡∏ô **‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ 10%** ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏õ **‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ** ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô`;
            } else {
                 adviceMessage = `üí° **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô) ‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ FinTrack AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥`;
            }

            analysisHtml += `
                <div class="p-4 bg-emerald-50 rounded-lg border-l-4 border-emerald-600">
                    <p class="text-sm font-semibold text-emerald-800 mb-1">üéØ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∏‡∏Å FinTrack AI:</p>
                    <p class="text-gray-700 text-sm">${adviceMessage}</p>
                </div>
            `;

            // Add a final disclaimer
            analysisHtml += `
                <div class="mt-4 p-2 text-xs text-gray-500 bg-white rounded-lg border border-gray-200">
                    *‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÇ‡∏î‡∏¢ FinTrack AI ‡πÅ‡∏•‡∏∞‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Local Storage ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                </div>
            `;

            return analysisHtml;
        }


        /**
         * Calculates and renders the dashboard summary and category analysis. (UPDATED)
         */
        function renderDashboard() {
            let totalIncome = 0;
            let totalExpense = 0;
            const categoryTotals = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            // 1. Update summary cards
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome) + ' ‡∏ø';
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense) + ' ‡∏ø';
            document.getElementById('netBalance').textContent = formatCurrency(netBalance) + ' ‡∏ø';
            document.getElementById('netBalance').className = `text-2xl font-bold mt-1 ${netBalance >= 0 ? 'balance-color' : 'expense-color'}`;
            
            // 2. Render Charts
            renderCharts(categoryTotals, totalExpense);

            // 3. Render AI Analysis (UPDATED: Use deep analysis)
            const analysisEl = document.getElementById('categoryAnalysis');
            
            // ** Call the new AI Analysis function **
            analysisEl.innerHTML = generateAiAnalysis(totalIncome, totalExpense, netBalance, categoryTotals);
        }

        // =======================================================================
        // AI CONSULTATION LOGIC (SIMULATED CHATBOT)
        // =======================================================================
        
        const chatContainer = document.getElementById('chatMessages');

        /**
         * Renders a message bubble in the chat view.
         * @param {'user'|'ai'} sender
         * @param {string} text
         */
        function displayMessage(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.className = sender === 'user' 
                ? 'flex justify-end mb-4' 
                : 'flex justify-start mb-4';

            messageEl.innerHTML = `
                <div class="${sender === 'user' ? 'bg-blue-500 text-white rounded-bl-xl' : 'bg-gray-200 text-gray-800 rounded-br-xl'} 
                            max-w-xs lg:max-w-md p-3 rounded-t-xl shadow-md whitespace-pre-wrap">
                    ${text}
                </div>
            `;
            chatContainer.appendChild(messageEl);
            // Scroll to the latest message
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * Handles the user's consultation query.
         */
        window.handleAiConsultation = function(event) {
            event.preventDefault();
            const form = event.target;
            const queryInput = form.querySelector('#consultationInput');
            const query = queryInput.value.trim();

            if (!query) return;

            // 1. Display user query
            displayMessage('user', query);
            queryInput.value = '';

            // 2. Simulate AI processing time (optional delay for realism)
            setTimeout(() => {
                // 3. Generate AI response
                const response = generateAiResponse(query);
                
                // 4. Display AI response
                displayMessage('ai', response);
            }, 500);
        }

        /**
         * Generates a specialized financial advice response based on the query (simulated AI).
         * @param {string} query
         * @returns {string} Financial advice string.
         */
        function generateAiResponse(query) {
            // ‡πÉ‡∏ä‡πâ regex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢, ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç, ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å)
            const normalizedQuery = query.toLowerCase().replace(/[^\u0E00-\u0E7F\w\s]/g, ''); 

            // --- Keywords and Responses based on Financial Best Practices ---
            if (normalizedQuery.includes('‡∏≠‡∏≠‡∏°') || normalizedQuery.includes('‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô') || normalizedQuery.includes('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö')) {
                return `
                    üí° **‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ:**
                    1. **‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:** ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 10-20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
                    2. **‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô:** ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **3-6 ‡πÄ‡∏ó‡πà‡∏≤** ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á
                    3. **‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ SMART:** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏≠‡∏° 50,000 ‡∏ö‡∏≤‡∏ó ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏õ‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏£‡∏ñ")
                    4. **‡πÉ‡∏ä‡πâ‡∏Å‡∏é 50/30/20:** ‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô 50% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô, 30% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß, ‡πÅ‡∏•‡∏∞ 20% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô
                `;
            }

            if (normalizedQuery.includes('‡∏•‡∏á‡∏ó‡∏∏‡∏ô') || normalizedQuery.includes('‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô') || normalizedQuery.includes('‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô')) {
                return `
                    üìà **‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô:**
                    1. **‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:** ‡∏ñ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô ‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏≤‡∏©‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏á‡∏¥‡∏ô/‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ
                    2. **‡∏ä‡∏ô‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠:** ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3-5% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡∏î‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏≤‡∏•‡∏á
                    3. **‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå DCA:** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏¢‡∏≠‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏ß‡∏î‡πÜ (**Dollar Cost Average**) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    4. **‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:** ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô **3-5 ‡∏õ‡∏µ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤** ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                `;
            }
            
            if (normalizedQuery.includes('‡∏´‡∏ô‡∏µ‡πâ') || normalizedQuery.includes('‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï') || normalizedQuery.includes('‡∏ú‡πà‡∏≠‡∏ô')) {
                return `
                    üìâ **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ:**
                    1. **‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ:** ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô **45%** ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    2. **‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:** ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î **‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á** (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï, ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•) ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
                    3. **‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ:** ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≠‡∏á Need ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                    4. **‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:** ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î!
                `;
            }

            if (normalizedQuery.includes('‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') || normalizedQuery.includes('‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞') || normalizedQuery.includes('‡∏£‡∏π‡∏£‡∏±‡πà‡∏ß') || normalizedQuery.includes('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢')) {
                 return `
                    ‚úÇÔ∏è **‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û:**
                    1. **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Budget Killer:** ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏î‡∏°‡∏µ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏ô‡∏±‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡∏£‡∏π‡∏£‡∏±‡πà‡∏ß" ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                    2. **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budgeting):** ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡∏î‡∏•‡∏á **10-15%** ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    3. **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:** ‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡πá‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î
                `;
            }

            if (normalizedQuery.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || normalizedQuery.includes('‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ')) {
                 return `
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞! FinTrack AI ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á **‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ** ‡∏´‡∏£‡∏∑‡∏≠ **‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢** ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡∏∞?
                `;
            }
            
            if (normalizedQuery.includes('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì') || normalizedQuery.includes('‡∏î‡∏µ‡∏°‡∏≤‡∏Å')) {
                 return `
                    ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞! ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏ñ‡∏≤‡∏° FinTrack AI ‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞
                `;
            }

            // Default response
            return `
                ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ FinTrack AI ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î
                
                ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô:
                - **‡∏≠‡∏≠‡∏°/‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô**
                - **‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡∏´‡∏∏‡πâ‡∏ô**
                - **‡∏´‡∏ô‡∏µ‡πâ/‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï**
                - **‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢**
                
                *FinTrack AI ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á*
            `;
        }

        // =======================================================================
        // IMPORT FUNCTION (CSV)
        // =======================================================================
        
        /**
         * Imports transactions from a CSV file (matching export format).
         * Assumes headers: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤', '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'
         */
        window.importCSV = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    // ‡∏•‡∏ö BOM (\ufeff) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    const cleanedCsv = csv.startsWith('\ufeff') ? csv.substring(1) : csv;
                    const lines = cleanedCsv.split('\n').filter(line => line.trim() !== '');

                    if (lines.length <= 1) {
                        alertCustom('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        return;
                    }
                    
                    // ‡πÉ‡∏ä‡πâ regex ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ Double Quotes
                    const parseCSVLine = (line) => {
                        const results = [];
                        let inQuotes = false;
                        let field = '';
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];

                            if (char === '"') {
                                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö escape quote: ""
                                if (inQuotes && line[i + 1] === '"') {
                                    field += '"';
                                    i++; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ " ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                results.push(field.trim());
                                field = '';
                            } else {
                                field += char;
                            }
                        }
                        results.push(field.trim());
                        return results.map(r => r.startsWith('"') && r.endsWith('"') ? r.slice(1, -1) : r);
                    };

                    const newTransactions = [];
                    const headers = parseCSVLine(lines[0]);
                    const expectedHeaders = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤', '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'];

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Header (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                    if (headers.slice(0, 5).join(',') !== expectedHeaders.slice(0, 5).join(',')) {
                        alertCustom('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á CSV ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡πÑ‡∏ß‡πâ (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤, ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)');
                        return;
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        
                        if (values.length < 5) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö

                        const typeStr = values[1];
                        const amountStr = values[4];

                        const type = typeStr === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? 'income' : 'expense';
                        // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô Parse
                        const amount = parseFloat(amountStr.replace(/,/g, ''));
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                        if (isNaN(amount) || amount <= 0) continue; 

                        newTransactions.push({
                            id: Date.now().toString() + i + Math.random().toString(36).substring(2, 5), // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
                            type: type,
                            date: values[0].replace(/"/g, ''), // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤
                            category: values[2].replace(/"/g, ''), // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            description: values[3].replace(/"/g, ''), // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            amount: amount,
                            timestamp: new Date().toISOString(),
                        });
                    }

                    if (newTransactions.length > 0) {
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
                        transactions.push(...newTransactions);
                        saveTransactions();
                        loadTransactions(); 
                        alertCustom('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${newTransactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    } else {
                        alertCustom('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                    }
                    
                } catch (error) {
                    console.error("CSV Import Error:", error);
                    alertCustom('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                } finally {
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input file ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
                    event.target.value = '';
                }
            };
            reader.readAsText(file, 'UTF-8');
        }


        // =======================================================================
        // EXPORT FUNCTION (CSV)
        // =======================================================================

        /**
         * Exports all transaction data to a CSV file.
         */
        window.exportCSV = function() {
            if (transactions.length === 0) {
                alertCustom('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const headers = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤', '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'];

            // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°
            // ‡πÉ‡∏ä‡πâ .sort() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà)
            const chronologicalTxs = [...transactions].sort((a, b) => a.date.localeCompare(b.date));

            let runningBalance = 0;
            
            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CSV
            const csvData = chronologicalTxs.map(t => {
                const amountValue = t.amount;
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                const effectiveAmount = t.type === 'income' ? amountValue : -amountValue;
                
                runningBalance += effectiveAmount;

                return [
                    // 1. Date/Time (ISO format for re-import and accuracy)
                    // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Double Quotes ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ CSV ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Date/Time ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    `"${t.date}"`, 
                    // 2. Type (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)
                    t.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', 
                    // 3. Category (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡πÉ‡∏ä‡πâ Double Quotes ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ
                    `"${t.category.replace(/"/g, '""')}"`, 
                    // 4. Description (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - Sanitize ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Double Quotes
                    `"${t.description.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ')}"`, 
                    // 5. Price/Amount (‡∏£‡∏≤‡∏Ñ‡∏≤) - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å
                    amountValue.toFixed(2), 
                    // 6. Running Balance (‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) - ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                    runningBalance.toFixed(2), 
                ];
            });

            // 4. ‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const csvArray = [headers.join(','), ...csvData.map(row => row.join(','))];
            let csvString = csvArray.join('\n');
            
            // 5. Export setup (‡πÄ‡∏û‡∏¥‡πà‡∏° BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Excel)
            const bom = "\ufeff";
            csvString = bom + csvString;
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `financial_report_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // =======================================================================
        // UI CONTROL
        // =======================================================================

        /**
         * Switches between Dashboard and Transactions view.
         */
        window.switchTab = function(viewId) {
            const views = {
                dashboard: document.getElementById('dashboardView'),
                transactions: document.getElementById('transactionsView'),
                consultation: document.getElementById('consultationView')
            };
            const buttons = {
                dashboard: document.getElementById('tabDashboardBtn'),
                transactions: document.getElementById('tabTransactionBtn'),
                consultation: document.getElementById('tabConsultationBtn')
            };

            for (const key in views) {
                if (key === viewId) {
                    views[key].classList.remove('hidden');
                    buttons[key].classList.add('active');
                } else {
                    views[key].classList.add('hidden');
                    buttons[key].classList.remove('active');
                }
            }
        }

        /**
         * Custom Modal/Message Box (Replaces alert/confirm)
         */
        function alertCustom(title, body, onConfirm = null) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Alert
            confirmBtn.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            cancelBtn.classList.add('hidden');

            if (!onConfirm) {
                 confirmBtn.onclick = () => modal.classList.add('hidden');
            } else {
                 confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                };
            }

            modal.classList.remove('hidden');
        }

        /**
         * Custom Modal/Confirm Box (Replaces window.confirm)
         */
        function confirmCustom(title, body, onConfirm) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Confirm
            confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            confirmBtn.onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };
            cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
            cancelBtn.onclick = () => modal.classList.add('hidden');
            cancelBtn.classList.remove('hidden');

            modal.classList.remove('hidden');
        }

        // =======================================================================
        // START APPLICATION
        // =======================================================================

        window.onload = initLocalStorage;
    </script>
</body>
</html>
