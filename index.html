<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - Personal Finance Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, setDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (MUST be defined globally)
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.serverTimestamp = serverTimestamp;
        window.setLogLevel = setLogLevel;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .tab-button.active {
            border-bottom: 3px solid #10b981; /* Emerald 500 */
            color: #10b981;
            font-weight: 600;
        }
        .income-color { color: #10b981; }
        .expense-color { color: #ef4444; }
        .balance-color { color: #3b82f6; }
        .data-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-10">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üí∞ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô: ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

        <!-- User ID Display (Mandatory for multi-user apps) -->
        <div id="authStatus" class="mb-4 p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-300 mb-6 bg-white rounded-t-lg">
            <button id="tabDashboardBtn" onclick="switchTab('dashboard')" class="tab-button active flex-1 py-3 px-4 text-center text-gray-600 hover:text-emerald-500 transition duration-150">
                ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î &amp; ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            </button>
            <button id="tabTransactionBtn" onclick="switchTab('transactions')" class="tab-button flex-1 py-3 px-4 text-center text-gray-600 hover:text-emerald-500 transition duration-150">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
        </div>

        <!-- 1. Dashboard & Analysis View -->
        <div id="dashboardView" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Total Income Card -->
                <div class="bg-white p-5 rounded-xl data-card border-l-4 border-emerald-500">
                    <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
                    <p id="totalIncome" class="text-2xl font-bold income-color mt-1">0.00 ‡∏ø</p>
                </div>
                <!-- Total Expense Card -->
                <div class="bg-white p-5 rounded-xl data-card border-l-4 border-red-500">
                    <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
                    <p id="totalExpense" class="text-2xl font-bold expense-color mt-1">0.00 ‡∏ø</p>
                </div>
                <!-- Net Balance Card -->
                <div class="bg-white p-5 rounded-xl data-card border-l-4 border-blue-500">
                    <p class="text-sm text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <p id="netBalance" class="text-2xl font-bold balance-color mt-1">0.00 ‡∏ø</p>
                </div>
            </div>

            <!-- Budgeting and Category Analysis with Charts -->
            <div class="bg-white p-6 rounded-xl data-card mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                
                <!-- Chart Containers -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="p-4 border rounded-xl">
                        <h3 class="font-semibold text-gray-600 mb-2 border-b pb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Pie Chart)</h3>
                        <canvas id="expensePieChart"></canvas>
                        <p id="noPieData" class="text-center text-gray-500 hidden pt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                    </div>
                    <div class="p-4 border rounded-xl">
                        <h3 class="font-semibold text-gray-600 mb-2 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (Bar Chart)</h3>
                        <canvas id="expenseBarChart"></canvas>
                        <p id="noBarData" class="text-center text-gray-500 hidden pt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                    </div>
                </div>

                <!-- Existing Category List -->
                <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-3 border-t pt-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                <div id="categoryAnalysis" class="space-y-3">
                    <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                </div>
            </div>

            <!-- Data Export -->
            <div class="bg-white p-6 rounded-xl data-card mb-6 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-700">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <button onclick="exportCSV()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                    <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel/Sheets)
                </button>
            </div>
        </div>

        <!-- 2. Transaction Management View -->
        <div id="transactionsView" class="tab-content hidden">
            <!-- Add Transaction Form -->
            <div class="bg-white p-6 rounded-xl data-card mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="transactionForm" onsubmit="addTransaction(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                            <select id="type" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Income)</option>
                                <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Expense)</option>
                            </select>
                        </div>
                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <!-- Amount -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="amount" step="0.01" min="0.01" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 15000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</option>
                                <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Income)">
                                    <option value="Salary">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                    <option value="Investment">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</option>
                                    <option value="OtherIncome">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                </optgroup>
                                <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Expense)">
                                    <option value="Food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                    <option value="Housing">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô)</option>
                                    <option value="Transportation">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</option>
                                    <option value="Utilities">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ (‡∏ô‡πâ‡∏≥, ‡πÑ‡∏ü, ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå)</option>
                                    <option value="Entertainment">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á/‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                                    <option value="Shopping">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                                    <option value="Health">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</option>
                                    <option value="OtherExpense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏™‡∏±‡πâ‡∏ô‡πÜ)</label>
                        <input type="text" id="description" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î, ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <button type="submit" class="w-full mt-6 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="bg-white p-6 rounded-xl data-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ø)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList" class="bg-white divide-y divide-gray-200">
                            <!-- Transactions will be inserted here by JavaScript -->
                            <tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal/Message Box (for alerts/confirmations) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="messageTitle" class="text-lg font-bold mb-3 text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p id="messageBody" class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
            <div class="flex justify-end space-x-3">
                <button id="messageCancel" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="messageConfirm" class="py-2 px-4 bg-red-500 hover:bg-red-600 rounded-lg text-white transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script type="module">
        // =======================================================================
        // FIREBASE & UTILITY SETUP - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        // =======================================================================

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-finance-app';
        let db, auth, userId = null;
        let transactions = [];
        let authReady = false;

        // Global Chart Instances and Colors
        let pieChartInstance = null;
        let barChartInstance = null;
        const CHART_COLORS = [
            '#ef4444', // Red 500
            '#f97316', // Orange 500
            '#f59e0b', // Amber 500
            '#10b981', // Emerald 500
            '#3b82f6', // Blue 500
            '#8b5cf6', // Violet 500
            '#ec4899', // Pink 500
            '#6b7280', // Gray 500
            '#14b8a6', // Teal 500
            '#a855f7', // Purple 500
        ];

        /**
         * Converts number to formatted currency string (e.g., 10000 -> 10,000.00).
         * @param {number} num
         * @returns {string}
         */
        const formatCurrency = (num) => {
            return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                // setLogLevel('Debug'); // Uncomment for detailed console logs
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authStatusEl = document.getElementById('authStatus');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authReady = true;
                        // ‡πÅ‡∏™‡∏î‡∏á ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ô (‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                        authStatusEl.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="font-medium text-green-600">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span> | ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span class="font-mono text-xs">${userId}</span>`;
                        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (real-time listener)
                        loadTransactions();
                    } else {
                        // Attempt to sign in with custom token or anonymously
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('authStatus').innerHTML = `<span class="font-medium text-red-600">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</span>: ${error.message}`;
            }
        }

        // =======================================================================
        // DATA MANAGEMENT (CRUD)
        // =======================================================================

        /**
         * Gets the Firestore collection reference for user's private data.
         */
        function getTransactionCollectionRef() {
            if (!db || !userId) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/financial_transactions
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            return collection(db, 'artifacts', appId, 'users', userId, 'financial_transactions');
        }

        /**
         * Listens to real-time updates from Firestore. (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
         */
        function loadTransactions() {
            const ref = getTransactionCollectionRef();
            if (!ref) return;

            // onSnapshot ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
            onSnapshot(query(ref), (snapshot) => {
                const fetchedTransactions = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure amount is treated as a number
                    data.amount = parseFloat(data.amount);
                    fetchedTransactions.push({ id: doc.id, ...data });
                });

                // Sort by timestamp (newest first). Use JS sorting as orderBy() is often restricted.
                transactions = fetchedTransactions.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderTransactions();
                renderDashboard();
                console.log("Transactions updated:", transactions.length);

            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        }

        /**
         * Adds a new transaction to Firestore.
         * @param {Event} event
         */
        window.addTransaction = async function(event) {
            event.preventDefault();

            if (!authReady) {
                alertCustom('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            const form = event.target;
            const type = form.type.value;
            const date = form.date.value;
            const amount = parseFloat(form.amount.value);
            const category = form.category.value;
            const description = form.description.value.trim();

            if (isNaN(amount) || amount <= 0 || !category) {
                alertCustom('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const newTransaction = {
                type,
                date,
                amount,
                category,
                description,
                timestamp: serverTimestamp(), // Use Firestore timestamp for creation time
            };

            try {
                // addDoc ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Cloud
                await addDoc(getTransactionCollectionRef(), newTransaction);
                form.reset();
                form.date.value = new Date().toISOString().split('T')[0]; // Reset date to today
                // Reset category selection
                form.category.selectedIndex = 0;
            } catch (e) {
                console.error("Error adding document: ", e);
                alertCustom('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        /**
         * Deletes a transaction from Firestore.
         * @param {string} id
         */
        window.deleteTransaction = function(id) {
            confirmCustom('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£?', async () => {
                try {
                    const docRef = doc(getTransactionCollectionRef(), id);
                    // deleteDoc ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Cloud
                    await deleteDoc(docRef);
                    console.log("Document successfully deleted!");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alertCustom('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                }
            });
        }

        // =======================================================================
        // RENDERING & UI LOGIC
        // =======================================================================

        /**
         * Renders the transaction list table.
         */
        function renderTransactions() {
            const listEl = document.getElementById('transactionList');
            if (!listEl) return;

            if (transactions.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>';
                return;
            }

            listEl.innerHTML = transactions.map(t => {
                const amountClass = t.type === 'income' ? 'income-color font-semibold' : 'expense-color font-semibold';
                const sign = t.type === 'income' ? '+' : '-';

                return `
                    <tr class="hover:bg-gray-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-gray-500">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${amountClass}">
                            ${sign} ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renders the expense category charts using Chart.js.
         * @param {Object} categoryTotals - Object with category names as keys and total amount as values.
         * @param {number} totalExpense - Total expense amount.
         */
        function renderCharts(categoryTotals, totalExpense) {
            // 1. Prepare data
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, amount]) => amount);
            const colors = labels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const hasData = sortedCategories.length > 0;
            document.getElementById('noPieData').classList.toggle('hidden', hasData);
            document.getElementById('noBarData').classList.toggle('hidden', hasData);

            // 2. Destroy existing chart instances if they exist
            if (pieChartInstance) {
                pieChartInstance.destroy();
                pieChartInstance = null; // Clear reference
            }
            if (barChartInstance) {
                barChartInstance.destroy();
                barChartInstance = null; // Clear reference
            }

            if (!hasData) return; // Stop if no expense data to plot

            // --- Pie Chart (All Expenses) ---
            const pieCtx = document.getElementById('expensePieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter', // Apply Thai font family
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(1) : 0;
                                    return `${label}: ${formatCurrency(value)} ‡∏ø (${percentage}%)`;
                                }
                            },
                            bodyFont: { family: 'Inter' }, // Apply Thai font family
                        }
                    }
                }
            });

            // --- Bar Chart (Top 5 Expenses) ---
            const top5Categories = sortedCategories.slice(0, 5);
            const barLabels = top5Categories.map(([category]) => category);
            const barData = top5Categories.map(([, amount]) => amount);
            const barColors = barLabels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const barCtx = document.getElementById('expenseBarChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ø)',
                        data: barData,
                        backgroundColor: barColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Make it a horizontal bar chart for better label readability
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)',
                                font: { family: 'Inter' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                font: { family: 'Inter' }
                            }
                        },
                        y: {
                            ticks: {
                                font: { family: 'Inter' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { bodyFont: { family: 'Inter' } }
                    }
                }
            });
        }


        /**
         * Calculates and renders the dashboard summary and category analysis.
         */
        function renderDashboard() {
            let totalIncome = 0;
            let totalExpense = 0;
            const categoryTotals = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            // 1. Update summary cards
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome) + ' ‡∏ø';
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense) + ' ‡∏ø';
            document.getElementById('netBalance').textContent = formatCurrency(netBalance) + ' ‡∏ø';
            document.getElementById('netBalance').className = `text-2xl font-bold mt-1 ${netBalance >= 0 ? 'balance-color' : 'expense-color'}`;
            
            // 2. Render Charts
            renderCharts(categoryTotals, totalExpense);

            // 3. Render Category Analysis (Simple Bar Chart using CSS/Tailwind - kept for detailed list view)
            const analysisEl = document.getElementById('categoryAnalysis');
            const totalExpenseForAnalysis = totalExpense;

            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                analysisEl.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>';
                return;
            }

            analysisEl.innerHTML = sortedCategories.map(([category, amount]) => {
                const percentage = totalExpenseForAnalysis > 0 ? ((amount / totalExpenseForAnalysis) * 100).toFixed(1) : 0;
                const widthStyle = `width: ${percentage}%`;

                return `
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-700">${category}</span>
                            <span class="text-red-500 font-semibold">${formatCurrency(amount)} ‡∏ø (${percentage}%)</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-red-400 rounded-full" style="${widthStyle}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =======================================================================
        // EXPORT FUNCTION (Kept the UTF-8 BOM fix)
        // =======================================================================

        /**
         * Exports all transaction data to a CSV file.
         */
        window.exportCSV = function() {
            if (transactions.length === 0) {
                alertCustom('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            const headers = ['ID', 'Date', 'Type', 'Category', 'Description', 'Amount', 'Timestamp_Seconds'];

            // Map data to CSV format
            const csvData = transactions.map(t => [
                t.id,
                t.date,
                t.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                t.category,
                // Sanitize description for CSV (replace quotes and remove new lines)
                `"${t.description.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ')}"`,
                t.amount,
                t.timestamp?.seconds || ''
            ]);

            // Combine headers and data
            const csvArray = [headers.join(','), ...csvData.map(row => row.join(','))];
            let csvString = csvArray.join('\n');
            
            // FIX: Prepend UTF-8 BOM (\ufeff) to the string to ensure Excel recognizes Thai characters correctly.
            const bom = "\ufeff";
            csvString = bom + csvString;


            // Create Blob and download link
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `financial_report_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // =======================================================================
        // UI CONTROL
        // =======================================================================

        /**
         * Switches between Dashboard and Transactions view.
         * @param {string} viewId 'dashboard' or 'transactions'
         */
        window.switchTab = function(viewId) {
            const views = {
                dashboard: document.getElementById('dashboardView'),
                transactions: document.getElementById('transactionsView')
            };
            const buttons = {
                dashboard: document.getElementById('tabDashboardBtn'),
                transactions: document.getElementById('tabTransactionBtn')
            };

            for (const key in views) {
                if (key === viewId) {
                    views[key].classList.remove('hidden');
                    buttons[key].classList.add('active');
                } else {
                    views[key].classList.add('hidden');
                    buttons[key].classList.remove('active');
                }
            }
        }

        /**
         * Custom Modal/Message Box (Replaces alert/confirm)
         * @param {string} title
         * @param {string} body
         * @param {function} onConfirm Optional confirmation callback
         */
        function alertCustom(title, body, onConfirm = null) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Alert (only show confirm/OK button)
            confirmBtn.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            confirmBtn.onclick = () => modal.classList.add('hidden');
            cancelBtn.classList.add('hidden');

            if (onConfirm) { // If it's used as a generic custom function
                confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                };
            }

            modal.classList.remove('hidden');
        }

        /**
         * Custom Modal/Confirm Box (Replaces window.confirm)
         * @param {string} title
         * @param {string} body
         * @param {function} onConfirm Mandatory confirmation callback
         */
        function confirmCustom(title, body, onConfirm) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Confirm
            confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            confirmBtn.onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };
            cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
            cancelBtn.onclick = () => modal.classList.add('hidden');
            cancelBtn.classList.remove('hidden');

            modal.classList.remove('hidden');
        }

        // =======================================================================
        // START APPLICATION
        // =======================================================================

        window.onload = initFirebase;
    </script>
</body>
</html>
