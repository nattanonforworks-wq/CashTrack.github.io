<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://img.freepik.com/free-psd/money-illustration-isolated_23-2151568514.jpg">
    <title>FinTrack - ระบบติดตามการเงินส่วนบุคคล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styles for better visual separation */
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
        }
        .container-box {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 1.5rem;
        }
        .income-color {
            color: #10b981; /* Emerald 500 */
        }
        .expense-color {
            color: #ef4444; /* Red 500 */
        }
        .balance-color {
            color: #3b82f6; /* Blue 500 */
        }
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150;
        }
        .tab-btn.active {
            @apply bg-blue-600 text-white hover:bg-blue-700 shadow-md;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">
                <span class="text-blue-600">FinTrack</span> <span class="text-gray-400 text-base font-normal">ส่วนบุคคล</span>
            </h1>
            <div id="authStatus" class="text-xs text-gray-500">
                สถานะ: <span class="font-medium text-red-600">กำลังโหลด...</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="mb-6 flex space-x-3">
            <button id="tabDashboardBtn" class="tab-btn active" onclick="switchTab('dashboard')">
                แดชบอร์ด & AI Analysis
            </button>
            <button id="tabTransactionBtn" class="tab-btn" onclick="switchTab('transactions')">
                รายการธุรกรรมทั้งหมด
            </button>
        </div>

        <div class="mb-8">
             <div class="container-box p-6 bg-blue-50 border-t-4 border-blue-600">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">บันทึกรายการใหม่</h2>
                <form id="transactionForm" onsubmit="addTransaction(event)" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    
                    <div class="md:col-span-1">
                        <label for="type" class="block text-sm font-medium text-gray-700">ประเภท</label>
                        <select id="type" name="type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                            <option value="expense">รายจ่าย</option>
                            <option value="income">รายรับ</option>
                        </select>
                    </div>

                    <div class="md:col-span-1">
                        <label for="date" class="block text-sm font-medium text-gray-700">วันที่/เวลา</label>
                        <input type="datetime-local" id="date" name="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2">
                    </div>

                    <div class="md:col-span-1">
                        <label for="amount" class="block text-sm font-medium text-gray-700">จำนวนเงิน (฿)</label>
                        <input type="number" id="amount" name="amount" step="0.01" min="0.01" required placeholder="100.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2">
                    </div>
                    
                    <div class="md:col-span-1">
                        <label for="category" class="block text-sm font-medium text-gray-700">หมวดหมู่/รายการ</label>
                         <select id="category" name="category" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                            <option value="" disabled selected>เลือกหมวดหมู่...</option>
                            <optgroup label="รายจ่าย (Expense)">
                                <option value="อาหารและเครื่องดื่ม">อาหารและเครื่องดื่ม</option>
                                <option value="เดินทางและยานพาหนะ">เดินทางและยานพาหนะ</option>
                                <option value="ค่าสาธารณูปโภค">ค่าสาธารณูปโภค</option>
                                <option value="ช้อปปิ้ง">ช้อปปิ้ง</option>
                                <option value="ความบันเทิง">ความบันเทิง</option>
                                <option value="สุขภาพและความงาม">สุขภาพและความงาม</option>
                                <option value="อื่นๆ (จ่าย)">อื่นๆ (จ่าย)</option>
                            </optgroup>
                            <optgroup label="รายรับ (Income)">
                                <option value="เงินเดือน">เงินเดือน</option>
                                <option value="รายได้เสริม">รายได้เสริม</option>
                                <option value="ปันผล/ดอกเบี้ย">ปันผล/ดอกเบี้ย</option>
                                <option value="อื่นๆ (รับ)">อื่นๆ (รับ)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="md:col-span-1">
                        <label for="description" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                        <input type="text" id="description" name="description" placeholder="ซื้อกาแฟ/โบนัสสิ้นปี" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2">
                    </div>

                    <div class="md:col-span-1">
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                            บันทึก
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="dashboardView">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                
                <div class="container-box border-l-4 border-emerald-500">
                    <p class="text-sm font-medium text-gray-500">รายรับทั้งหมด</p>
                    <p id="totalIncome" class="text-2xl font-bold mt-1 income-color">0.00 ฿</p>
                </div>
                
                <div class="container-box border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-500">รายจ่ายทั้งหมด</p>
                    <p id="totalExpense" class="text-2xl font-bold mt-1 expense-color">0.00 ฿</p>
                </div>

                <div class="container-box border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-500">ยอดคงเหลือสุทธิ</p>
                    <p id="netBalance" class="text-2xl font-bold mt-1 balance-color">0.00 ฿</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="container-box lg:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2h-4v2h4l2-2v13c0 .552.448 1 1 1h4c.552 0 1-.448 1-1V9l2-2h4v2h-4l-2 2v10c0 .552.448 1 1 1h4c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1h-4c-.552 0-1 .448-1 1v2c0 .552-.448 1-1 1h-4c-.552 0-1-.448-1-1V5c0-.552-.448-1-1-1h-4c-.552 0-1 .448-1 1v14"></path></svg>
                        FinTrack AI: วิเคราะห์และให้คำแนะนำ
                    </h2>
                    <div id="categoryAnalysis" class="space-y-4">
                        <p class="text-gray-500">กำลังโหลดการวิเคราะห์...</p>
                    </div>
                </div>

                <div class="container-box">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">สัดส่วนรายจ่ายตามหมวดหมู่</h2>
                    <div class="relative h-80">
                         <canvas id="expensePieChart"></canvas>
                         <p id="noPieData" class="absolute inset-0 flex items-center justify-center text-gray-500 bg-white/70 rounded-lg hidden">ไม่พบข้อมูลรายจ่าย</p>
                    </div>
                </div>

                <div class="container-box">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">5 อันดับแรกของรายจ่าย</h2>
                    <div class="relative h-80">
                        <canvas id="expenseBarChart"></canvas>
                        <p id="noBarData" class="absolute inset-0 flex items-center justify-center text-gray-500 bg-white/70 rounded-lg hidden">ไม่พบข้อมูลรายจ่าย</p>
                    </div>
                </div>

            </div>
        </div>

        <div id="transactionsView" class="hidden">
            <div class="container-box p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">รายการธุรกรรมทั้งหมด</h2>
                    <div class="flex space-x-3">
                        <button onclick="exportCSV()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                             <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                             ส่งออก CSV
                        </button>
                        <label for="csvFile" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                             <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                             นำเข้า CSV
                        </label>
                        <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="importCSV(event)">

                        <button onclick="clearAllData()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                             <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                             ล้างข้อมูล
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto shadow border-b border-gray-200 sm:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่/เวลา</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายละเอียด</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมวดหมู่</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนเงิน</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">ลบ</span></th>
                            </tr>
                        </thead>
                        <tbody id="transactionList" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="p-4 text-center text-gray-500">กำลังโหลดรายการ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
    
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 transition-opacity flex items-center justify-center">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full p-6">
            <div class="flex items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 id="messageTitle" class="text-lg leading-6 font-medium text-gray-900">หัวข้อ</h3>
                    <div class="mt-2">
                        <p id="messageBody" class="text-sm text-gray-500">รายละเอียด</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="messageConfirm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    ตกลง
                </button>
                <button type="button" id="messageCancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm hidden">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <script>
        // =======================================================================
        // LOCAL STORAGE & UTILITY SETUP - สำหรับการบันทึกข้อมูลในเครื่อง
        // =======================================================================

        const STORAGE_KEY = 'personalFinanceTransactions';
        let transactions = [];
        let userId = 'local-user'; 
        
        let pieChartInstance = null;
        let barChartInstance = null;
        const CHART_COLORS = [
            '#ef4444', // Red 500
            '#f97316', // Orange 600
            '#f59e0b', // Amber 500
            '#10b981', // Emerald 500
            '#3b82f6', // Blue 500
            '#8b5cf6', // Violet 500
            '#ec4899', // Pink 500
            '#6b7280', // Gray 500
            '#14b8a6', // Teal 500
            '#a855f7', // Purple 500
        ];

        /**
         * Converts number to formatted currency string (e.g., 10000 -> 10,000.00).
         * @param {number} num
         * @returns {string}
         */
        const formatCurrency = (num) => {
            return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        /**
         * Formats YYYY-MM-DDTHH:mm string to DD/MM/YYYY HH:mm น. (พ.ศ.)
         */
        const formatDateTime = (isoString) => {
            if (!isoString || isoString.length < 10) return isoString;
            try {
                // Split for YYYY-MM-DD and HH:mm
                const parts = isoString.split('T'); 
                const dateParts = parts[0].split('-'); 
                
                // Fallback for date-only format (old data)
                if (dateParts.length < 3) return isoString; 

                const buddhistYear = parseInt(dateParts[0]) + 543; 
                const date = `${dateParts[2]}/${dateParts[1]}/${buddhistYear}`;
                const time = parts[1] ? parts[1].substring(0, 5) : '00:00'; // Ensure HH:mm format
                return `${date} ${time} น.`;
            } catch (e) {
                return isoString;
            }
        };

        /**
         * Initializes the application by loading data from Local Storage.
         */
        function initLocalStorage() {
            // 1. อัปเดตสถานะ Auth (จำลอง)
            const authStatusEl = document.getElementById('authStatus');
            authStatusEl.innerHTML = `สถานะ: <span class="font-medium text-blue-600">ทำงานแบบออฟไลน์ (Local Storage)</span> | ID ผู้ใช้: <span class="font-mono text-xs">${userId}</span>`;
            
            // 2. โหลดข้อมูล
            loadTransactions();
            
            // 3. ตั้งค่าวันที่และเวลาเริ่มต้นในฟอร์ม
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const datetimeLocalString = now.toISOString().slice(0, 16);
            document.getElementById('date').value = datetimeLocalString;

            // 4. ตั้งค่า Chart.js font
            Chart.defaults.font.family = 'Noto Sans Thai, Inter, sans-serif';
        }

        /**
         * Saves the current transactions array to Local Storage.
         */
        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                console.log("Transactions saved to Local Storage:", transactions.length);
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
                alertCustom('บันทึกไม่สำเร็จ', 'ไม่สามารถบันทึกข้อมูลลงในเครื่องได้');
            }
        }

        /**
         * Loads transactions from Local Storage.
         */
        function loadTransactions() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    transactions = JSON.parse(storedData).map(t => ({
                        ...t,
                        amount: parseFloat(t.amount) // Ensure amount is a number
                    }));
                } else {
                    transactions = [];
                }
                // Sort by timestamp (newest first)
                transactions.sort((a, b) => {
                    const timeA = a.date || a.timestamp;
                    const timeB = b.date || b.timestamp;
                    // เรียงจากใหม่สุดไปเก่าสุด
                    return timeB.localeCompare(timeA); 
                });

                renderTransactions();
                renderDashboard();
                console.log("Transactions loaded:", transactions.length);

            } catch (e) {
                console.error("Error loading from Local Storage:", e);
            }
        }


        // =======================================================================
        // DATA MANAGEMENT (CRUD) - Local Storage Version
        // =======================================================================

        /**
         * Adds a new transaction.
         * @param {Event} event
         */
        window.addTransaction = function(event) {
            event.preventDefault();

            const form = event.target;
            const type = form.type.value;
            // date ตอนนี้เป็น datetime-local string (YYYY-MM-DDTHH:mm)
            const date = form.date.value; 
            const amount = parseFloat(form.amount.value);
            const category = form.category.value;
            const description = form.description.value.trim() || (type === 'income' ? 'รายรับทั่วไป' : 'ค่าใช้จ่ายทั่วไป');

            if (isNaN(amount) || amount <= 0 || !category) {
                alertCustom('ข้อมูลไม่ถูกต้อง', 'โปรดกรอกจำนวนเงินและหมวดหมู่ให้ถูกต้อง');
                return;
            }

            const newTransaction = {
                id: Date.now().toString() + Math.random().toString(36).substring(2, 9), 
                type,
                date, // YYYY-MM-DDTHH:mm
                amount,
                category,
                description,
                timestamp: new Date().toISOString(), 
            };

            transactions.unshift(newTransaction); 
            saveTransactions();
            loadTransactions(); 

            form.reset();
            // Reset date to current datetime
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('date').value = now.toISOString().slice(0, 16);
            
            form.category.selectedIndex = 0;
            
            switchTab('transactions'); 
        }

        /**
         * Deletes a transaction.
         * @param {string} id
         */
        window.deleteTransaction = function(id) {
            confirmCustom('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้อย่างถาวร?', () => {
                const initialLength = transactions.length;
                transactions = transactions.filter(t => t.id !== id);
                
                if (transactions.length < initialLength) {
                    saveTransactions();
                    loadTransactions(); 
                    console.log("Transaction successfully deleted locally.");
                } else {
                    alertCustom('ลบไม่สำเร็จ', 'ไม่พบรายการที่ต้องการลบ');
                }
            });
        }
        
        /**
         * Clears all data from Local Storage after confirmation.
         */
        window.clearAllData = function() {
            confirmCustom('ยืนยันการล้างข้อมูลทั้งหมด', 
                        'การดำเนินการนี้จะ **ลบรายการธุรกรรมทั้งหมด** ออกจากเครื่องอย่างถาวร! คุณแน่ใจหรือไม่?', 
                        () => {
                localStorage.removeItem(STORAGE_KEY);
                transactions = []; 
                loadTransactions(); 
                alertCustom('ล้างข้อมูลสำเร็จ', 'ข้อมูลธุรกรรมทั้งหมดถูกลบออกจากเครื่องแล้ว');
            });
        }


        // =======================================================================
        // RENDERING & UI LOGIC
        // =======================================================================

        /**
         * Renders the transaction list table.
         */
        function renderTransactions() {
            const listEl = document.getElementById('transactionList');
            if (!listEl) return;

            if (transactions.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">ยังไม่มีรายการบันทึก</td></tr>';
                return;
            }

            listEl.innerHTML = transactions.map(t => {
                const amountClass = t.type === 'income' ? 'income-color font-semibold' : 'expense-color font-semibold';
                const sign = t.type === 'income' ? '+' : '-';

                return `
                    <tr class="hover:bg-gray-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTime(t.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-gray-500">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${amountClass}">
                            ${sign} ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renders the expense category charts using Chart.js.
         */
        function renderCharts(categoryTotals, totalExpense) {
            // 1. Prepare data
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, amount]) => amount);
            const colors = labels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const hasData = sortedCategories.length > 0;
            document.getElementById('noPieData').classList.toggle('hidden', hasData);
            document.getElementById('noBarData').classList.toggle('hidden', hasData);

            // 2. Destroy existing chart instances if they exist
            if (pieChartInstance) {
                pieChartInstance.destroy();
                pieChartInstance = null;
            }
            if (barChartInstance) {
                barChartInstance.destroy();
                barChartInstance = null;
            }

            if (!hasData) return;

            // --- Pie Chart (All Expenses) ---
            const pieCtx = document.getElementById('expensePieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดรวมรายจ่าย (฿)',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Noto Sans Thai',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(1) : 0;
                                    return `${label}: ${formatCurrency(value)} ฿ (${percentage}%)`;
                                }
                            },
                            bodyFont: { family: 'Noto Sans Thai' },
                        }
                    }
                }
            });

            // --- Bar Chart (Top 5 Expenses) ---
            const top5Categories = sortedCategories.slice(0, 5);
            const barLabels = top5Categories.map(([category]) => category);
            const barData = top5Categories.map(([, amount]) => amount);
            const barColors = barLabels.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const barCtx = document.getElementById('expenseBarChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'ยอดรวมรายจ่าย (฿)',
                        data: barData,
                        backgroundColor: barColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'จำนวนเงิน (฿)',
                                font: { family: 'Noto Sans Thai' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                font: { family: 'Noto Sans Thai' }
                            }
                        },
                        y: {
                            ticks: {
                                font: { family: 'Noto Sans Thai' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { bodyFont: { family: 'Noto Sans Thai' } }
                    }
                }
            });
        }

        // =======================================================================
        // AI ANALYSIS FUNCTION (NEW)
        // =======================================================================
        
        /**
         * Simulates AI analysis of financial data.
         * @param {number} totalIncome
         * @param {number} totalExpense
         * @param {number} netBalance
         * @param {Object} categoryTotals - { category: amount, ... }
         * @returns {string} HTML string of analysis insights.
         */
        function generateAiAnalysis(totalIncome, totalExpense, netBalance, categoryTotals) {
            if (totalIncome === 0 && totalExpense === 0) {
                return `
                    <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                        <span class="text-xl">🤖</span>
                        <p class="text-gray-700 text-sm">
                            **FinTrack AI:** ขณะนี้ยังไม่มีข้อมูลรายรับและรายจ่ายที่เพียงพอสำหรับการวิเคราะห์เชิงลึก โปรดบันทึกรายการก่อนเริ่มการวิเคราะห์ครับ/ค่ะ
                        </p>
                    </div>
                `;
            }
            
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            const hasNegativeBalance = netBalance < 0;
            
            let analysisHtml = '';

            // Insight 1: Net Balance Summary
            const balanceColorClass = hasNegativeBalance ? 'text-red-600 font-bold' : 'text-emerald-600 font-bold';
            const balanceMessage = hasNegativeBalance 
                ? `ยอดคงเหลือสุทธิเป็น <span class="${balanceColorClass}">${formatCurrency(netBalance)} ฿ (ติดลบ)</span> ซึ่งเป็นสัญญาณที่ต้องเฝ้าระวัง`
                : `ยอดคงเหลือสุทธิอยู่ที่ <span class="${balanceColorClass}">${formatCurrency(netBalance)} ฿</span> แสดงว่าคุณมีการจัดการการเงินที่ดีในภาพรวม`;
                
            analysisHtml += `
                <div class="space-y-1 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-600">
                    <p class="text-sm font-semibold text-blue-800">สรุปสถานการณ์ทางการเงินเบื้องต้น:</p>
                    <p class="text-gray-700 text-sm">${balanceMessage} โดยมีรายรับทั้งหมด ${formatCurrency(totalIncome)} ฿ และรายจ่ายทั้งหมด ${formatCurrency(totalExpense)} ฿</p>
                </div>
            `;

            if (sortedCategories.length > 0) {
                const topCategory = sortedCategories[0];
                const topCategoryName = topCategory[0];
                const topCategoryAmount = topCategory[1];
                const topCategoryPercentage = (totalExpense > 0 ? (topCategoryAmount / totalExpense * 100).toFixed(1) : 0);

                // Insight 2: Top Expense Category Focus
                let expenseMessage = `รายจ่ายส่วนใหญ่ของคุณอยู่ในหมวดหมู่ **${topCategoryName}** ซึ่งคิดเป็นสัดส่วนสูงถึง ${topCategoryPercentage}% ของรายจ่ายทั้งหมด`;
                
                if (topCategoryPercentage > 40) {
                    expenseMessage += ' ⚠️ **สูงผิดปกติ** FinTrack AI แนะนำให้ตรวจสอบว่าการใช้จ่ายในหมวดหมู่นี้เกินกว่าแผนที่คุณวางไว้หรือไม่ และพิจารณาหาทางลดหย่อน';
                } else if (topCategoryPercentage > 20) {
                    expenseMessage += ' ซึ่งเป็นสัดส่วนสำคัญในการบริหารการเงินของคุณ ควรตั้งงบประมาณสำหรับหมวดหมู่นี้ให้ชัดเจน';
                } else {
                    expenseMessage += ' ซึ่งยังอยู่ในระดับที่สมเหตุสมผล แต่ก็ควรติดตามอย่างใกล้ชิด';
                }
                
                analysisHtml += `
                    <div class="space-y-1 p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-600">
                        <p class="text-sm font-semibold text-yellow-800">โฟกัสรายจ่ายหลัก:</p>
                        <p class="text-gray-700 text-sm">${expenseMessage}</p>
                    </div>
                `;

                // Insight 3: Proactive Advice (Budgeting/Saving)
                const suggestion = netBalance >= 0 
                    ? `ยอดคงเหลือเป็นบวก FinTrack AI แนะนำให้จัดสรรเงินส่วนนี้เพื่อ **การออมหรือลงทุน** ${Math.max(5, (netBalance / totalIncome * 100).toFixed(0))}% ทันทีที่ได้รับรายรับ`
                    : `ยอดคงเหลือเป็นลบ FinTrack AI แนะนำให้ **ลดการใช้จ่ายที่ไม่จำเป็น** ในหมวดหมู่หลัก และวางแผนการชำระหนี้เพื่อลดภาระดอกเบี้ย`;

                analysisHtml += `
                    <div class="space-y-1 p-3 bg-emerald-50 rounded-lg border-l-4 border-emerald-600">
                        <p class="text-sm font-semibold text-emerald-800">คำแนะนำ FinTrack AI:</p>
                        <p class="text-gray-700 text-sm">${suggestion}</p>
                    </div>
                `;

            } else if (totalIncome > 0 && totalExpense === 0) {
                analysisHtml += `
                    <div class="space-y-1 p-3 bg-emerald-50 rounded-lg border-l-4 border-emerald-600">
                        <p class="text-sm font-semibold text-emerald-800">คำแนะนำ FinTrack AI:</p>
                        <p class="text-gray-700 text-sm">ยอดคงเหลือเป็นบวกเต็มจำนวน! อย่าลืมบันทึกรายการรายจ่ายเพื่อให้การวิเคราะห์มีความแม่นยำและช่วยให้คุณจัดการเงินได้ดียิ่งขึ้นครับ/ค่ะ</p>
                    </div>
                `;
            }
            
            // Add a final disclaimer
            analysisHtml += `
                <div class="mt-4 p-2 text-xs text-gray-500 bg-white rounded-lg border">
                    *การวิเคราะห์นี้จำลองโดย FinTrack AI และอ้างอิงจากข้อมูลที่บันทึกไว้ใน Local Storage เท่านั้น
                </div>
            `;


            return analysisHtml;
        }


        /**
         * Calculates and renders the dashboard summary and category analysis.
         */
        function renderDashboard() {
            let totalIncome = 0;
            let totalExpense = 0;
            const categoryTotals = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            // 1. Update summary cards
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome) + ' ฿';
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense) + ' ฿';
            document.getElementById('netBalance').textContent = formatCurrency(netBalance) + ' ฿';
            document.getElementById('netBalance').className = `text-2xl font-bold mt-1 ${netBalance >= 0 ? 'balance-color' : 'expense-color'}`;
            
            // 2. Render Charts
            renderCharts(categoryTotals, totalExpense);

            // 3. Render AI Analysis (UPDATED: Use AI Analysis)
            const analysisEl = document.getElementById('categoryAnalysis');
            
            // ** Call the new AI Analysis function **
            analysisEl.innerHTML = generateAiAnalysis(totalIncome, totalExpense, netBalance, categoryTotals);
        }

        // =======================================================================
        // IMPORT FUNCTION (CSV)
        // =======================================================================
        
        /**
         * Imports transactions from a CSV file (matching export format).
         * Assumes headers: 'วันที่/เวลา', 'รายรับ/รายจ่าย', 'รายการ', 'รายละเอียดรายการ', 'ราคา', 'ยอดคงเหลือ'
         */
        window.importCSV = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    // ลบ BOM (\ufeff) ถ้ามี
                    const cleanedCsv = csv.startsWith('\ufeff') ? csv.substring(1) : csv;
                    const lines = cleanedCsv.split('\n').filter(line => line.trim() !== '');

                    if (lines.length <= 1) {
                        alertCustom('นำเข้าไม่สำเร็จ', 'ไฟล์ CSV ไม่มีข้อมูลหรือมีรูปแบบไม่ถูกต้อง');
                        return;
                    }
                    
                    // ใช้ regex ที่ซับซ้อนขึ้นเพื่อจัดการ CSV ที่มี Double Quotes
                    const parseCSVLine = (line) => {
                        const results = [];
                        let inQuotes = false;
                        let field = '';
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];

                            if (char === '"') {
                                // ตรวจสอบ escape quote: ""
                                if (inQuotes && line[i + 1] === '"') {
                                    field += '"';
                                    i++; // ข้ามตัวอักษร " ถัดไป
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                results.push(field.trim());
                                field = '';
                            } else {
                                field += char;
                            }
                        }
                        results.push(field.trim());
                        return results.map(r => r.startsWith('"') && r.endsWith('"') ? r.slice(1, -1) : r);
                    };

                    const newTransactions = [];
                    const headers = parseCSVLine(lines[0]);
                    const expectedHeaders = ['วันที่/เวลา', 'รายรับ/รายจ่าย', 'รายการ', 'รายละเอียดรายการ', 'ราคา', 'ยอดคงเหลือ'];

                    // ตรวจสอบความถูกต้องของ Header (อย่างน้อยต้องมี 5 คอลัมน์ที่จำเป็น)
                    if (headers.slice(0, 5).join(',') !== expectedHeaders.slice(0, 5).join(',')) {
                        alertCustom('รูปแบบไม่ถูกต้อง', 'รูปแบบหัวตาราง CSV ไม่ตรงกับที่คาดไว้ (วันที่/เวลา, รายรับ/รายจ่าย, รายการ, รายละเอียดรายการ, ราคา, ยอดคงเหลือ)');
                        return;
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        
                        if (values.length < 5) continue; // ข้ามแถวที่ข้อมูลไม่ครบ

                        const typeStr = values[1];
                        const amountStr = values[4];

                        const type = typeStr === 'รายรับ' ? 'income' : 'expense';
                        // ลบเครื่องหมายจุลภาคออกจากตัวเลขก่อน Parse
                        const amount = parseFloat(amountStr.replace(/,/g, ''));
                        
                        // ตรวจสอบข้อมูลพื้นฐาน
                        if (isNaN(amount) || amount <= 0) continue; 

                        newTransactions.push({
                            id: Date.now().toString() + i + Math.random().toString(36).substring(2, 5), // สร้าง ID ใหม่
                            type: type,
                            date: values[0].replace(/"/g, ''), // วันที่/เวลา
                            category: values[2].replace(/"/g, ''), // รายการ
                            description: values[3].replace(/"/g, ''), // รายละเอียดรายการ
                            amount: amount,
                            timestamp: new Date().toISOString(),
                        });
                    }

                    if (newTransactions.length > 0) {
                        // เพิ่มรายการใหม่เข้าไปในรายการเดิม (ไม่ล้างข้อมูลเดิม)
                        transactions.push(...newTransactions);
                        saveTransactions();
                        loadTransactions(); 
                        alertCustom('นำเข้าสำเร็จ', `นำเข้ารายการธุรกรรมใหม่สำเร็จ ${newTransactions.length} รายการ`);
                    } else {
                        alertCustom('นำเข้าไม่สำเร็จ', 'ไม่พบรายการธุรกรรมที่ถูกต้องในไฟล์');
                    }
                    
                } catch (error) {
                    console.error("CSV Import Error:", error);
                    alertCustom('เกิดข้อผิดพลาด', 'ไม่สามารถประมวลผลไฟล์ CSV ได้ โปรดตรวจสอบรูปแบบไฟล์');
                } finally {
                    // ล้างค่าใน input file เพื่อให้สามารถนำเข้าไฟล์เดิมซ้ำได้
                    event.target.value = '';
                }
            };
            reader.readAsText(file, 'UTF-8');
        }


        // =======================================================================
        // EXPORT FUNCTION (CSV)
        // =======================================================================

        /**
         * Exports all transaction data to a CSV file.
         */
        window.exportCSV = function() {
            if (transactions.length === 0) {
                alertCustom('ไม่พบข้อมูล', 'ไม่มีรายการบันทึกที่จะส่งออก');
                return;
            }

            // 1. กำหนดหัวข้อคอลัมน์ตามที่ผู้ใช้ต้องการ
            const headers = ['วันที่/เวลา', 'รายรับ/รายจ่าย', 'รายการ', 'รายละเอียดรายการ', 'ราคา', 'ยอดคงเหลือ'];

            // 2. เตรียมข้อมูลเรียงลำดับจากเก่าไปใหม่เพื่อคำนวณยอดคงเหลือสะสม
            // ใช้ .sort() เพื่อเรียงลำดับเวลา/วันที่แบบขึ้น (เก่าไปใหม่)
            const chronologicalTxs = [...transactions].sort((a, b) => a.date.localeCompare(b.date));

            let runningBalance = 0;
            
            // 3. คำนวณยอดคงเหลือและจัดรูปแบบข้อมูลสำหรับ CSV
            const csvData = chronologicalTxs.map(t => {
                const amountValue = t.amount;
                // กำหนดเครื่องหมายสำหรับคำนวณยอดคงเหลือ
                const effectiveAmount = t.type === 'income' ? amountValue : -amountValue;
                
                runningBalance += effectiveAmount;

                return [
                    // 1. Date/Time (ISO format for re-import and accuracy)
                    // ใช้การครอบด้วย Double Quotes เพื่อให้มั่นใจว่า CSV อ่านค่า Date/Time ได้ถูกต้อง
                    `"${t.date}"`, 
                    // 2. Type (รายรับ/รายจ่าย)
                    t.type === 'income' ? 'รายรับ' : 'รายจ่าย', 
                    // 3. Category (รายการ) - ใช้ Double Quotes เพื่อรองรับข้อความที่มีเครื่องหมายจุลภาค
                    `"${t.category.replace(/"/g, '""')}"`, 
                    // 4. Description (รายละเอียดรายการ) - Sanitize และครอบด้วย Double Quotes
                    `"${t.description.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ')}"`, 
                    // 5. Price/Amount (ราคา) - ใช้ค่าบวก
                    amountValue.toFixed(2), 
                    // 6. Running Balance (ยอดคงเหลือ) - หลังจากรายการนี้
                    runningBalance.toFixed(2), 
                ];
            });

            // 4. รวมหัวข้อและข้อมูล
            const csvArray = [headers.join(','), ...csvData.map(row => row.join(','))];
            let csvString = csvArray.join('\n');
            
            // 5. Export setup (เพิ่ม BOM สำหรับรองรับภาษาไทยใน Excel)
            const bom = "\ufeff";
            csvString = bom + csvString;
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `financial_report_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // =======================================================================
        // UI CONTROL
        // =======================================================================

        /**
         * Switches between Dashboard and Transactions view.
         */
        window.switchTab = function(viewId) {
            const views = {
                dashboard: document.getElementById('dashboardView'),
                transactions: document.getElementById('transactionsView')
            };
            const buttons = {
                dashboard: document.getElementById('tabDashboardBtn'),
                transactions: document.getElementById('tabTransactionBtn')
            };

            for (const key in views) {
                if (key === viewId) {
                    views[key].classList.remove('hidden');
                    buttons[key].classList.add('active');
                } else {
                    views[key].classList.add('hidden');
                    buttons[key].classList.remove('active');
                }
            }
        }

        /**
         * Custom Modal/Message Box (Replaces alert/confirm)
         */
        function alertCustom(title, body, onConfirm = null) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Alert
            confirmBtn.textContent = 'ตกลง';
            cancelBtn.classList.add('hidden');

            if (!onConfirm) {
                confirmBtn.onclick = () => modal.classList.add('hidden');
            } else {
                confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                };
            }

            modal.classList.remove('hidden');
        }

        /**
         * Custom Modal/Confirm Box (Replaces window.confirm)
         */
        function confirmCustom(title, body, onConfirm) {
            const modal = document.getElementById('messageBox');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            const confirmBtn = document.getElementById('messageConfirm');
            const cancelBtn = document.getElementById('messageCancel');

            // Setup for Confirm
            confirmBtn.textContent = 'ยืนยัน';
            confirmBtn.onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };
            cancelBtn.textContent = 'ยกเลิก';
            cancelBtn.onclick = () => modal.classList.add('hidden');
            cancelBtn.classList.remove('hidden');

            modal.classList.remove('hidden');
        }

        // =======================================================================
        // START APPLICATION
        // =======================================================================

        window.onload = initLocalStorage;
    </script>
</body>
</html>
